---
import '../styles/global.css';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';

interface Props {
  title?: string;
  description?: string;
  image?: string;
  globalCss?: string;
  headScripts?: string;
  withChrome?: boolean;
  active?: 'home' | 'catalog' | 'about';
}

const {
  title = 'CRYPTORO',
  description = '',
  image,
  globalCss = '',
  headScripts = '',
  withChrome = false,
  active
} = Astro.props;

const ogImage = image || '/images/og-default.jpg';
const ogUrl = Astro.url?.toString() || '';
---
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title}</title>
    <meta name="description" content={description} />
    <meta name="robots" content="index, follow" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImage} />
    <meta property="og:url" content={ogUrl} />
    <meta property="og:locale" content="ru_RU" />
    <meta property="og:site_name" content="CRYPTORO" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImage} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="keywords" content="AI диктофон, CRYPTORO, Plaud Note, транскрипция, запись встреч, диктофон с ChatGPT" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Unbounded:wght@700;900&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    {globalCss && <style is:global set:html={globalCss} />}
    {headScripts && <Fragment set:html={headScripts} />}
    <style is:global>
      :root{
        --bg:#ffffff;
        --bg-2:#f9fafb;
        --surface:rgba(255,255,255,.9);
        --surface-2:rgba(255,255,255,.82);
        --text:#111111;
        --muted:#4b5563;
        --line:rgba(255,255,255,.3);
        --accent-a:#ff4500;
        --accent-b:#ffd700;
        --glass-shadow:0 4px 30px rgba(0,0,0,.1);
      }
      html,body{
        background:var(--bg)!important;
        color:var(--text)!important;
        font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif!important;
      }
      .wrap,.hero-inner,.nav-inner,.foot-grid,.foot-bot,.catalog-controls,.mx-auto.max-w-7xl,.hero-grid,.tabs-wrap,.related-wrap{
        max-width:80rem!important;
        margin-left:auto!important;
        margin-right:auto!important;
        padding-left:1rem!important;
        padding-right:1rem!important;
      }
      @media (min-width:768px){
        .wrap,.hero-inner,.nav-inner,.foot-grid,.foot-bot,.catalog-controls,.mx-auto.max-w-7xl,.hero-grid,.tabs-wrap,.related-wrap{padding-left:2rem!important;padding-right:2rem!important}
      }
      @media (min-width:1024px){
        .wrap,.hero-inner,.nav-inner,.foot-grid,.foot-bot,.catalog-controls,.mx-auto.max-w-7xl,.hero-grid,.tabs-wrap,.related-wrap{padding-left:3rem!important;padding-right:3rem!important}
      }
      header{
        background:rgba(255,255,255,.9)!important;
        border-bottom:1px solid rgba(0,0,0,.08)!important;
        backdrop-filter:blur(20px)!important;
      }
      header a, nav a, .logo, .foot-logo, .foot-col h4, .sec-title, .ftitle, .stitle, .pname, .pname2, .rvname, .wname, .dname, .payname, .clabel, .cval, h1, h2, h3, h4{
        color:var(--text)!important;
      }
      p, span, li, .sec-sub, .hero-sub, .hero-label, .fdesc, .pdesc, .rvtext, .lprivacy, .citem, .ddesc, .wdesc, .paydesc, .foot-desc, .foot-col a, .foot-bot, .faqa, .md-body, .specs-table td{
        color:var(--muted)!important;
      }
      footer{
        background:rgba(255,255,255,.92)!important;
        border-top:1px solid rgba(0,0,0,.08)!important;
        backdrop-filter:blur(20px)!important;
      }
      section, .sec, .about-hero, .catalog-hero, main, body.bg-zinc-100{
        background:var(--bg)!important;
      }
      .sec:nth-of-type(even), .tabs-section, .related-section, .sec-products, .sec-features, .sec-how, .sec-usecases, .sec-pricing, .sec-reviews, .sec-faq, .sec-lead{
        background:var(--bg-2)!important;
      }
      .pcard,.fcard,.rvcard,.uccard,.pricingcard,.dcard,.paycard,.wcard,.mstat,.contact-cta,.citem,.faqitem,.smock,.hitem,.abadge,.tab-content,.rcard,.delivery-mini,.main-img,.reveal.relative.mb-10 > div,.consult-modal-card{
        background:var(--surface)!important;
        border-color:var(--line)!important;
        border:1px solid var(--line)!important;
        backdrop-filter:blur(20px)!important;
        box-shadow:var(--glass-shadow)!important;
        border-radius:1rem!important;
      }
      .pimg-wrap,.catalog-media,.rcard img{
        background:transparent!important;
      }
      .btn-blue,.pbtn,.pbtn2.fil,.compare-btn,.lsubmit,.buy-btn,.sticky-btn,.pbtn-preorder,.filter-btn.active,.contact-cta a,.inline-flex.w-full,.consult-btn.primary{
        background:#111!important;
        color:#fff!important;
        border:none!important;
        border-radius:12px!important;
        box-shadow:0 0 0 rgba(255,69,0,0)!important;
      }
      .pbadge,.pbadge2,.card-badge{
        background:#111!important;
        color:#fff!important;
        border:1px solid #111!important;
      }
      .btn-blue:hover,.pbtn:hover,.pbtn2.fil:hover,.compare-btn:hover,.lsubmit:hover,.buy-btn:hover,.sticky-btn:hover,.pbtn-preorder:hover,.filter-btn.active:hover,.contact-cta a:hover,.inline-flex.w-full:hover,.consult-btn.primary:hover{
        transform:scale(1.04)!important;
        box-shadow:0 12px 24px rgba(0,0,0,.16)!important;
      }
      .btn-ghost,.pbtn2.out,.btn-woutline,.filter-btn,.sort-select,.secondary-btn,.consult-btn{
        color:#111!important;
        background:rgba(255,255,255,.86)!important;
        border:1px solid rgba(0,0,0,.18)!important;
        backdrop-filter:blur(20px)!important;
      }
      .catalog-sort{display:none!important}
      .catalog-chips{
        background:rgba(243,244,246,.9)!important;
        border-color:rgba(0,0,0,.1)!important;
        border-radius:999px!important;
      }
      .filter-btn{
        color:#111!important;
        position:relative;
      }
      .catalog-chips .filter-btn::after{
        content:'';
        position:absolute;
        left:14px;
        right:14px;
        bottom:5px;
        height:2px;
        background:#111;
        transform:scaleX(0);
        transform-origin:left center;
        transition:transform .25s ease;
      }
      .catalog-chips .filter-btn:hover::after,
      .catalog-chips .filter-btn.active::after,
      .catalog-chips .filter-btn.bg-zinc-900::after{transform:scaleX(1)}
      .filter-btn:hover{
        transform:translateY(-1px) scale(1.02)!important;
        border-color:rgba(0,0,0,.32)!important;
      }
      .faqarr{background:rgba(0,0,0,.06)!important;color:#111!important}
      .faqitem.open .faqarr{background:linear-gradient(90deg,var(--accent-a),var(--accent-b))!important;color:#111!important}
      .faqa{padding-left:1rem!important;overflow:hidden!important}
      .section-divider,.foot-div,hr{border-color:rgba(0,0,0,.12)!important}
      .reveal,.pcard,.rcard,.fcard,.dcard,.wcard,.paycard,.mstat,.faqitem{
        transition:all .3s ease-out!important;
      }
      .pcard:hover,.rcard:hover,.fcard:hover,.dcard:hover,.wcard:hover,.paycard:hover,.mstat:hover{
        transform:translateY(-4px) scale(1.02)!important;
        box-shadow:0 18px 32px rgba(0,0,0,.14)!important;
      }
      .hero-title,.prod-name,.sec-title,.lead-title{
        font-family:'Unbounded','Inter',sans-serif!important;
      }
      .hero{
        background:radial-gradient(65% 85% at 82% 14%, rgba(255,69,0,.2), transparent 58%), linear-gradient(180deg,#ffffff 0%,#f9fafb 100%)!important;
      }
      .hero-title{color:#111!important}
      .hero-sub,.hero-label{color:#4b5563!important}
      .hero .btn-ghost{border-color:rgba(0,0,0,.2)!important;color:#111!important}
      .hero .btn-ghost:hover{border-color:#111!important}
      .mobile-menu-toggle{
        display:none;
        align-items:center;
        justify-content:center;
        width:36px;
        height:36px;
        border:1px solid rgba(0,0,0,.14);
        border-radius:999px;
        background:#fff;
        color:#111;
        cursor:pointer;
      }
      .mobile-nav-panel{
        display:none;
        position:absolute;
        top:56px;
        left:14px;
        right:14px;
        background:#fff;
        border:1px solid rgba(0,0,0,.1);
        border-radius:14px;
        box-shadow:0 14px 34px rgba(0,0,0,.12);
        padding:12px;
        z-index:120;
      }
      .mobile-nav-close{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        width:30px;
        height:30px;
        border:1px solid rgba(0,0,0,.14);
        border-radius:999px;
        background:#fff;
        color:#111;
        font-size:18px;
        line-height:1;
        margin-left:auto;
        cursor:pointer;
      }
      .mobile-nav-panel a{
        display:block;
        padding:10px 12px;
        border-radius:10px;
        color:#111;
        font-size:15px;
        text-decoration:none;
      }
      .mobile-nav-panel a:hover{background:#f3f4f6}
      .mobile-nav-open .mobile-nav-panel{display:block}
      .consult-modal{
        position:fixed;
        inset:0;
        display:none;
        z-index:140;
        background:rgba(17,24,39,.5);
        padding:16px;
      }
      .consult-modal.open{display:flex;align-items:center;justify-content:center}
      .consult-modal-card{
        width:min(560px,100%);
        background:#fff;
        color:#111;
        border-radius:18px;
        border:1px solid rgba(255,255,255,.3);
        box-shadow:0 4px 30px rgba(0,0,0,.1);
        backdrop-filter:blur(20px);
        padding:20px;
      }
      .consult-modal-title{
        font-family:'Unbounded',sans-serif;
        font-size:24px;
        line-height:1.15;
        margin-bottom:8px;
      }
      .consult-modal-sub{color:#4b5563;font-size:14px;line-height:1.6;margin-bottom:14px}
      .consult-grid{display:grid;gap:10px}
      .consult-input{
        width:100%;
        border:1px solid rgba(0,0,0,.14);
        border-radius:12px;
        padding:12px 14px;
        font-size:15px;
        font-family:'Inter',sans-serif;
        color:#111;
        background:#fff;
      }
      .consult-actions{
        display:flex;
        gap:10px;
        justify-content:flex-end;
        margin-top:12px;
      }
      .consult-btn{
        border:1px solid rgba(0,0,0,.2);
        border-radius:12px;
        padding:10px 14px;
        font-size:14px;
        font-weight:600;
        cursor:pointer;
        background:#fff;
        color:#111;
      }
      .consult-btn.primary{
        background:#111;
        border-color:#111;
        color:#fff;
      }
      .fade-in{
        opacity:0;
        transform:translateY(16px);
        transition:opacity .52s ease, transform .52s ease;
      }
      .fade-in.in-view{
        opacity:1;
        transform:translateY(0);
      }
      @media (max-width: 768px){
        .mobile-menu-toggle{display:inline-flex}
        nav{display:none!important}
        #productsGrid{grid-template-columns:1fr!important}
        .hero-inner,.how-grid,.feat-grid,.products-grid,.delivery-grid,.payment-grid,.warranty-grid,.contacts-grid,.related-grid{
          grid-template-columns:1fr!important;
        }
        .specs-table,.specs-table tbody,.specs-table tr,.specs-table td{
          display:block!important;
          width:100%!important;
        }
        .specs-table td{
          padding:10px 0!important;
        }
      }
    </style>
    <slot name="head" />
  </head>
  <body>
    {withChrome && <Header active={active} />}
    <slot />
    {withChrome && <Footer />}
    <script is:inline>
      (function () {
        const KEY = 'cryptoro_cart_count';
        const ITEMS_KEY = 'cryptoro_cart';
        const LEGACY_ITEMS_KEY = 'cryptoro_cart_items';

        function readItems() {
          try {
            const raw = window.localStorage.getItem(ITEMS_KEY) ?? window.localStorage.getItem(LEGACY_ITEMS_KEY);
            const parsed = raw ? JSON.parse(raw) : [];
            return Array.isArray(parsed) ? parsed : [];
          } catch {
            return [];
          }
        }

        function writeItems(items) {
          window.localStorage.setItem(ITEMS_KEY, JSON.stringify(items));
          window.localStorage.removeItem(LEGACY_ITEMS_KEY);
        }

        function read() {
          const value = Number(window.localStorage.getItem(KEY) || '0');
          return Number.isFinite(value) && value > 0 ? Math.floor(value) : 0;
        }

        function write(value) {
          window.localStorage.setItem(KEY, String(Math.max(0, Math.floor(value))));
        }

        function paint(value) {
          document.querySelectorAll('#cartCount, .cart-n, [data-cart-count]').forEach((node) => {
            node.textContent = String(value);
            node.style.display = value > 0 ? 'flex' : 'none';
          });
        }

        function sync() {
          const items = readItems();
          if (items.length > 0) {
            write(items.length);
            paint(items.length);
            return;
          }
          const fallbackCount = read();
          paint(fallbackCount);
        }

        function add(payloadOrStep) {
          const items = readItems();
          if (payloadOrStep && typeof payloadOrStep === 'object') {
            items.push({
              ...payloadOrStep,
              qty: 1,
              addedAt: Date.now()
            });
          } else {
            const step = Math.max(1, Math.floor(payloadOrStep || 1));
            for (let i = 0; i < step; i += 1) {
              items.push({ qty: 1, addedAt: Date.now(), source: 'quick-add' });
            }
          }
          writeItems(items);
          write(items.length);
          paint(items.length);
          window.dispatchEvent(new CustomEvent('cart:updated', { detail: { count: items.length } }));
          return items.length;
        }

        function clear() {
          writeItems([]);
          write(0);
          paint(0);
          window.dispatchEvent(new CustomEvent('cart:updated', { detail: { count: 0 } }));
        }

        window.cryptoroCart = { read, write, readItems, writeItems, sync, add, clear };

        function bindCartButtons() {
          document.querySelectorAll('#cartBtn, [data-cart-btn], button.cart, .cart, button[aria-label="Корзина"]').forEach((button) => {
            if (button.dataset.cartBound === '1') return;
            button.dataset.cartBound = '1';
            button.addEventListener('click', () => {
              window.location.href = '/cart';
            });
          });
        }

        function setupMobileNav() {
          const isMobile = window.matchMedia('(max-width: 768px)').matches;
          document.querySelectorAll('header').forEach((header) => {
            if (header.dataset.mobileNavReady === '1') return;
            const nav = header.querySelector('nav');
            if (!nav) return;
            const navParent = nav.parentElement;
            if (!navParent) return;
            if (!isMobile) {
              header.dataset.mobileNavReady = '1';
              return;
            }

            const links = Array.from(nav.querySelectorAll('a'))
              .map((a) => ({ href: a.getAttribute('href') || '#', text: (a.textContent || '').trim() }))
              .filter((x) => x.text);
            if (!links.length) return;

            const toggle = document.createElement('button');
            toggle.type = 'button';
            toggle.className = 'mobile-menu-toggle';
            toggle.setAttribute('aria-label', 'Открыть меню');
            toggle.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 7h16M4 12h16M4 17h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>';

            const panel = document.createElement('div');
            panel.className = 'mobile-nav-panel';
            panel.innerHTML = `<button type="button" class="mobile-nav-close" aria-label="Закрыть меню">×</button>${links.map((item) => `<a href="${item.href}">${item.text}</a>`).join('')}`;

            toggle.addEventListener('click', () => {
              header.classList.toggle('mobile-nav-open');
            });
            const closeBtn = panel.querySelector('.mobile-nav-close');
            if (closeBtn) {
              closeBtn.addEventListener('click', () => header.classList.remove('mobile-nav-open'));
            }
            panel.querySelectorAll('a').forEach((link) => {
              link.addEventListener('click', () => header.classList.remove('mobile-nav-open'));
            });
            document.addEventListener('click', (event) => {
              if (!header.contains(event.target)) header.classList.remove('mobile-nav-open');
            });

            navParent.appendChild(toggle);
            navParent.style.position = 'relative';
            navParent.appendChild(panel);
            header.dataset.mobileNavReady = '1';
          });
        }

        function setupConsultModal() {
          if (document.getElementById('consultModal')) return;
          const modal = document.createElement('div');
          modal.id = 'consultModal';
          modal.className = 'consult-modal';
          modal.setAttribute('aria-hidden', 'true');
          modal.innerHTML = `
            <div class="consult-modal-card" role="dialog" aria-modal="true" aria-labelledby="consultTitle">
              <h3 id="consultTitle" class="consult-modal-title">Получить консультацию</h3>
              <p class="consult-modal-sub">Подберем модель под ваши задачи и бюджет.</p>
              <form name="consult" method="POST" data-netlify="true" netlify-honeypot="bot-field" class="consult-grid">
                <input type="hidden" name="form-name" value="consult" />
                <input type="hidden" name="bot-field" />
                <input class="consult-input" type="text" name="name" placeholder="Имя" required />
                <input class="consult-input" type="email" name="email" placeholder="Email" required />
                <input class="consult-input" type="tel" name="tel" placeholder="Телефон" required />
                <textarea class="consult-input" name="message" rows="4" placeholder="Кратко опишите задачу"></textarea>
                <div class="consult-actions">
                  <button type="button" class="consult-btn" data-consult-close>Отмена</button>
                  <button type="submit" class="consult-btn primary">Отправить</button>
                </div>
              </form>
            </div>
          `;
          document.body.appendChild(modal);

          const openModal = () => {
            modal.classList.add('open');
            modal.setAttribute('aria-hidden', 'false');
          };
          const closeModal = () => {
            modal.classList.remove('open');
            modal.setAttribute('aria-hidden', 'true');
          };

          modal.addEventListener('click', (event) => {
            if (event.target === modal) closeModal();
          });
          modal.querySelectorAll('[data-consult-close]').forEach((btn) => btn.addEventListener('click', closeModal));
          document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') closeModal();
          });

          const isHome = window.location.pathname === '/';
          document.querySelectorAll('a[href="/#lead"], a[href="#lead"], [data-open-consult]').forEach((link) => {
            if (isHome && link.getAttribute('href') === '#lead') return;
            link.addEventListener('click', (event) => {
              event.preventDefault();
              openModal();
            });
          });
        }

        function setupFadeIn() {
          if (!('IntersectionObserver' in window)) return;
          const nodes = document.querySelectorAll('.reveal, [data-fade]');
          if (!nodes.length) return;
          const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add('in-view', 'vis');
                if (entry.target.classList.contains('opacity-0')) {
                  entry.target.classList.remove('opacity-0');
                  entry.target.classList.add('opacity-100');
                }
                if (entry.target.classList.contains('translate-y-5')) {
                  entry.target.classList.remove('translate-y-5');
                  entry.target.classList.add('translate-y-0');
                }
                observer.unobserve(entry.target);
              }
            });
          }, { threshold: 0.08 });

          nodes.forEach((node) => {
            node.classList.add('fade-in');
            observer.observe(node);
          });
        }

        function setupAccessibilityLabels() {
          document.querySelectorAll('a, button').forEach((node) => {
            if (node.getAttribute('aria-label')) return;
            const text = (node.textContent || '').trim().replace(/\s+/g, ' ');
            if (text) node.setAttribute('aria-label', text.slice(0, 100));
          });
        }

        function dedupeCatalogTabs() {
          if (window.location.pathname.indexOf('/catalog') !== 0) return;
          const rows = Array.from(document.querySelectorAll('.catalog-chips'));
          rows.slice(1).forEach((row) => row.remove());
        }

        document.addEventListener('DOMContentLoaded', () => {
          sync();
          bindCartButtons();
          setupMobileNav();
          setupConsultModal();
          setupFadeIn();
          setupAccessibilityLabels();
          dedupeCatalogTabs();
        });
      })();
    </script>
  </body>
</html>
