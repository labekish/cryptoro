---
import Layout from '../layouts/Layout.astro';
import { loadLegacyPage } from '../lib/legacy';

const page = loadLegacyPage('catalog.html');
type ProductFM = { slug: string; price: number; sku?: string; skus?: string[] };
const modules = import.meta.glob('../content/products/*.{md,mdx}', { eager: true }) as Record<
  string,
  { frontmatter: ProductFM }
>;
const prices = Object.values(modules).reduce<Record<string, number>>((acc, mod) => {
  if (mod.frontmatter?.slug) acc[mod.frontmatter.slug] = Number(mod.frontmatter.price || 0);
  return acc;
}, {});
const skus = Object.values(modules).reduce<Record<string, string[]>>((acc, mod) => {
  if (!mod.frontmatter?.slug) return acc;
  const nextSkus = [
    ...(Array.isArray(mod.frontmatter?.skus) ? mod.frontmatter.skus : []),
    ...(mod.frontmatter?.sku ? [mod.frontmatter.sku] : [])
  ].filter(Boolean);
  if (nextSkus.length) acc[mod.frontmatter.slug] = Array.from(new Set(nextSkus));
  return acc;
}, {});
const formatPrice = (value: number) => `${Math.round(Number(value || 0)).toLocaleString('ru-RU')} ₽`;

let syncedBody = page.body;
const cardSlugs = ['vspomnit', 'plaud-note', 'plaud-note-pro', 'notepin', 'accessories'];

function patchCard(slug: string, patcher: (cardHtml: string) => string) {
  const cardRegex = new RegExp(`(<a[^>]*href="/products/${slug}"[^>]*>[\\s\\S]*?<\\/a>)`, 'i');
  syncedBody = syncedBody.replace(cardRegex, (cardHtml) => patcher(cardHtml));
}

cardSlugs.forEach((slug) => {
  const price = prices[slug];
  if (price == null) return;

  patchCard(slug, (cardHtml) => {
    let next = cardHtml;
    next = next.replace(/(data-price=")([^"]*)(")/i, `$1${Math.round(price)}$3`);
    next = next.replace(/(<div class="text-2xl font-bold">)([^<]*)(<\/div>)/i, `$1${formatPrice(price)}$3`);
    next = next.replace(/(<span class="text-2xl font-bold">)([^<]*)(<\/span>)/i, `$1${formatPrice(price)}$3`);
    return next;
  });
});

Object.entries(skus).forEach(([slug, skuList]) => {
  const primarySku = skuList[0];
  if (!primarySku) return;
  const skuListCsv = skuList.join(',');
  patchCard(slug, (cardHtml) => {
    let next = cardHtml;

    if (!/data-ms-sku=/i.test(next)) {
      next = next.replace(/<a([^>]*?)>/i, `<a$1 data-ms-sku="${primarySku}" data-ms-skus="${skuListCsv}">`);
    } else if (!/data-ms-skus=/i.test(next)) {
      next = next.replace(/<a([^>]*?)data-ms-sku="[^"]*"([^>]*?)>/i, `<a$1data-ms-sku="${primarySku}" data-ms-skus="${skuListCsv}"$2>`);
    }

    next = next.replace(
      /(<div class="text-2xl font-bold")(?![^>]*data-ms-price)([^>]*>)/i,
      `$1 data-ms-price="${slug}"$2`
    );
    next = next.replace(
      /(<span class="text-2xl font-bold")(?![^>]*data-ms-price)([^>]*>)/i,
      `$1 data-ms-price="${slug}"$2`
    );
    if (!new RegExp(`data-ms-stock="${slug}"`, 'i').test(next)) {
      next = next.replace(
        /(<div class="mt-auto pt-5">)/i,
        `$1<div data-ms-stock="${slug}" class="ms-stock-badge"></div><div data-ms-variants="${slug}" class="ms-variant-list"></div>`
      );
    } else if (!new RegExp(`data-ms-variants="${slug}"`, 'i').test(next)) {
      next = next.replace(
        new RegExp(`(<div[^>]*data-ms-stock="${slug}"[^>]*><\\/div>)`, 'i'),
        `$1<div data-ms-variants="${slug}" class="ms-variant-list"></div>`
      );
    }
    return next;
  });
});
---
<Layout
  title={page.title}
  description="Каталог AI-диктофонов CRYPTORO: Вспомни всё, Plaud Note, Plaud Note Pro, Plaud NotePin. Цены, характеристики, доставка по России."
  globalCss={page.css}
  headScripts={page.headScripts}
  withChrome={false}
>
  <Fragment set:html={syncedBody} />
</Layout>
