---
import Layout from '../layouts/Layout.astro';
import { loadLegacyPage } from '../lib/legacy';

const page = loadLegacyPage('catalog.html');
type ProductFM = { slug: string; price: number };
const modules = import.meta.glob('../content/products/*.{md,mdx}', { eager: true }) as Record<
  string,
  { frontmatter: ProductFM }
>;
const prices = Object.values(modules).reduce<Record<string, number>>((acc, mod) => {
  if (mod.frontmatter?.slug) acc[mod.frontmatter.slug] = Number(mod.frontmatter.price || 0);
  return acc;
}, {});
const formatPrice = (value: number) => `${Math.round(Number(value || 0)).toLocaleString('ru-RU')} ₽`;

let syncedBody = page.body;
const cardSlugs = ['vspomnit', 'plaud-note', 'plaud-note-pro', 'notepin', 'accessories'];

cardSlugs.forEach((slug) => {
  const price = prices[slug];
  if (price == null) return;

  syncedBody = syncedBody.replace(
    new RegExp(`(<a[^>]*href="/products/${slug}"[^>]*data-price=")([^"]*)(")`, 'i'),
    `$1${Math.round(price)}$3`
  );

  syncedBody = syncedBody.replace(
    new RegExp(`(<a[^>]*href="/products/${slug}"[\\s\\S]*?<div class="text-2xl font-bold">)([^<]*)(</div>)`, 'i'),
    `$1${formatPrice(price)}$3`
  );

  syncedBody = syncedBody.replace(
    new RegExp(`(<a[^>]*href="/products/${slug}"[\\s\\S]*?<span class="text-2xl font-bold">)([^<]*)(</span>)`, 'i'),
    `$1${formatPrice(price)}$3`
  );
});
---
<Layout
  title={page.title}
  description="Каталог AI-диктофонов CRYPTORO: Вспомни всё, Plaud Note, Plaud Note Pro, Plaud NotePin. Цены, характеристики, доставка по России."
  globalCss={page.css}
  headScripts={page.headScripts}
  withChrome={false}
>
  <Fragment set:html={syncedBody} />
</Layout>
