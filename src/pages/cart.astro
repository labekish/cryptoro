---
import Layout from '../layouts/Layout.astro';
---
<Layout title="Корзина | CRYPTORO" description="Оформление заказа CRYPTORO" withChrome={true} active="catalog">
  <main class="cart-page">
    <section class="cart-wrap">
      <div class="cart-head">
        <h1>Корзина</h1>
        <p>Проверьте состав заказа, заполните данные для доставки и отправьте заявку.</p>
      </div>

      <div class="cart-grid">
        <div class="cart-panel">
          <div id="cartEmpty" class="empty-state" hidden>
            <p>Корзина пуста. Добавьте товар из каталога.</p>
            <a class="dark-btn" href="/catalog">Перейти в каталог</a>
          </div>
          <div id="cartList" class="items-list"></div>
        </div>

        <div class="checkout-panel">
          <h2>Оформление заказа</h2>
          <div class="summary-row">
            <span>Итоговая сумма</span>
            <strong id="cartTotal">0 ₽</strong>
          </div>

          <form id="checkoutForm" class="checkout-form">
            <div class="field-grid">
              <label>Имя и фамилия
                <input name="fullName" type="text" required />
              </label>
              <label>Телефон
                <input name="phone" type="tel" required />
              </label>
              <label>Email
                <input name="email" type="email" required />
              </label>
            </div>

            <div class="field-grid">
              <label>Город
                <input name="city" type="text" required />
              </label>
              <label>Улица
                <input name="street" type="text" required />
              </label>
              <label>Индекс
                <input name="zip" type="text" required />
              </label>
            </div>

            <fieldset class="delivery-group">
              <legend>Способ доставки</legend>
              <label><input type="radio" name="delivery" value="СДЭК (2–7 дней)" checked />СДЭК (2–7 дней)</label>
              <label><input type="radio" name="delivery" value="Почта России (5–14 дней)" />Почта России (5–14 дней)</label>
              <label><input type="radio" name="delivery" value="Яндекс Доставка (Москва, 1 день)" />Яндекс Доставка (только Москва, 1 день)</label>
              <p class="delivery-note">Точную стоимость доставки сообщим после оформления заказа</p>
            </fieldset>

            <div class="actions">
              <button type="submit" id="submitBtn" class="dark-btn">Оформить заказ</button>
              <button type="button" id="cardPayBtn" class="ghost-btn">Оплатить картой</button>
            </div>
          </form>

          <p id="formMessage" class="form-message" aria-live="polite"></p>
        </div>
      </div>
    </section>
  </main>

  <script>
    import { clearCart, getCart, getCartCount, removeFromCart, updateCartQty } from '../utils/cart';

    const cartList = document.getElementById('cartList');
    const cartEmpty = document.getElementById('cartEmpty');
    const cartTotal = document.getElementById('cartTotal');
    const checkoutForm = document.getElementById('checkoutForm');
    const submitBtn = document.getElementById('submitBtn');
    const cardPayBtn = document.getElementById('cardPayBtn');
    const formMessage = document.getElementById('formMessage');

    function money(value) {
      return `${new Intl.NumberFormat('ru-RU').format(value)} ₽`;
    }

    function renderCart() {
      // Перерисовка всей корзины из localStorage.
      const items = getCart();
      const isEmpty = !items.length;
      if (cartEmpty) cartEmpty.hidden = !isEmpty;
      if (checkoutForm) checkoutForm.style.display = isEmpty ? 'none' : 'block';

      if (cartList) {
        if (isEmpty) {
          cartList.innerHTML = '';
        } else {
          cartList.innerHTML = items
            .map((item) => {
              const qty = Math.max(1, Number(item.qty) || 1);
              return `
                <article class="cart-item" data-item-id="${item.id}">
                  <img src="${item.image}" alt="Товар ${item.name}" />
                  <div class="cart-item-main">
                    <h3>${item.name}</h3>
                    <p>${money(item.price)}</p>
                    <div class="qty-row">
                      <button type="button" data-action="minus" aria-label="Уменьшить количество">−</button>
                      <input type="number" min="1" value="${qty}" data-qty-input />
                      <button type="button" data-action="plus" aria-label="Увеличить количество">+</button>
                    </div>
                  </div>
                  <button class="remove-btn" type="button" data-action="remove">Удалить</button>
                </article>
              `;
            })
            .join('');
        }
      }

      const total = items.reduce((sum, item) => sum + item.price * Math.max(1, Number(item.qty) || 1), 0);
      if (cartTotal) cartTotal.textContent = money(total);
      window.dispatchEvent(new CustomEvent('cart:updated', { detail: { count: getCartCount() } }));
    }

    document.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLElement)) return;
      const action = target.dataset.action;
      if (!action) return;
      const row = target.closest('[data-item-id]');
      if (!row) return;
      const id = row.getAttribute('data-item-id');
      if (!id) return;

      if (action === 'remove') {
        // Удаление позиции целиком.
        removeFromCart(id);
      }

      if (action === 'minus' || action === 'plus') {
        const input = row.querySelector('[data-qty-input]');
        if (!(input instanceof HTMLInputElement)) return;
        const current = Math.max(1, Number(input.value) || 1);
        const next = action === 'minus' ? Math.max(1, current - 1) : current + 1;
        updateCartQty(id, next);
      }

      renderCart();
    });

    document.addEventListener('change', (event) => {
      const target = event.target;
      if (!(target instanceof HTMLInputElement) || !target.hasAttribute('data-qty-input')) return;
      const row = target.closest('[data-item-id]');
      if (!row) return;
      const id = row.getAttribute('data-item-id');
      if (!id) return;
      updateCartQty(id, Math.max(1, Number(target.value) || 1));
      renderCart();
    });

    if (cardPayBtn) {
      cardPayBtn.addEventListener('click', () => {
        if (formMessage) {
          formMessage.textContent = 'Оплата картой будет доступна в ближайшее время';
          formMessage.className = 'form-message warn';
        }
      });
    }

    if (checkoutForm && submitBtn) {
      checkoutForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const items = getCart();
        if (!items.length) return;

        const formData = new FormData(checkoutForm);
        const payload = {
          fullName: String(formData.get('fullName') || ''),
          phone: String(formData.get('phone') || ''),
          email: String(formData.get('email') || ''),
          city: String(formData.get('city') || ''),
          street: String(formData.get('street') || ''),
          zip: String(formData.get('zip') || ''),
          delivery: String(formData.get('delivery') || ''),
          cart: items.map((item) => `${item.name} x${Math.max(1, Number(item.qty) || 1)} — ${money(item.price)}`).join('\n'),
          total: cartTotal?.textContent || ''
        };

        const requiredOk = payload.fullName && payload.phone && payload.email && payload.city && payload.street && payload.zip;
        if (!requiredOk) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправляем...';
        try {
          // Отправка заявки в Formspree без бэкенда.
          const response = await fetch('https://formspree.io/f/mnjbvkjq', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            body: JSON.stringify(payload)
          });

          if (!response.ok) throw new Error('request_failed');

          clearCart();
          // После успешной отправки очищаем корзину.
          checkoutForm.reset();
          renderCart();
          if (formMessage) {
            formMessage.textContent = 'Спасибо! Мы свяжемся с вами в течение 30 минут';
            formMessage.className = 'form-message ok';
          }
        } catch {
          if (formMessage) {
            formMessage.textContent = 'Ошибка отправки. Попробуйте ещё раз.';
            formMessage.className = 'form-message err';
          }
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Оформить заказ';
        }
      });
    }

    renderCart();
  </script>

  <style>
    .cart-page{padding:96px 0 80px;background:#f9fafb;min-height:72vh}
    .cart-wrap{max-width:1280px;margin:0 auto;padding:0 24px}
    .cart-head{margin-bottom:20px}
    .cart-head h1{font-family:'Unbounded',sans-serif;font-size:clamp(34px,5vw,56px);line-height:1.04;letter-spacing:-.02em;color:#111;margin:0 0 12px}
    .cart-head p{font-size:17px;color:#4b5563;line-height:1.6;margin:0}
    .cart-grid{display:grid;grid-template-columns:1.2fr .9fr;gap:20px}
    .cart-panel,.checkout-panel{background:rgba(255,255,255,.9);border:1px solid rgba(255,255,255,.3);border-radius:18px;box-shadow:0 4px 30px rgba(0,0,0,.1);backdrop-filter:blur(20px);padding:22px}
    .checkout-panel h2{font-family:'Unbounded',sans-serif;font-size:24px;line-height:1.2;margin:0 0 14px}
    .items-list{display:grid;gap:14px}
    .cart-item{display:grid;grid-template-columns:96px 1fr auto;gap:14px;align-items:center;padding:14px;border:1px solid rgba(0,0,0,.08);border-radius:14px;background:#fff}
    .cart-item img{width:96px;height:96px;object-fit:contain;background:#fff}
    .cart-item-main h3{font-size:22px;line-height:1.2;margin:0 0 8px;color:#111}
    .cart-item-main p{font-size:18px;font-weight:700;margin:0 0 10px;color:#111}
    .qty-row{display:inline-flex;align-items:center;gap:8px}
    .qty-row button{width:34px;height:34px;border-radius:10px;border:1px solid rgba(0,0,0,.15);background:#fff;font-size:22px;line-height:1;cursor:pointer}
    .qty-row input{width:64px;height:34px;border-radius:10px;border:1px solid rgba(0,0,0,.15);text-align:center;font-size:16px}
    .remove-btn{border:none;background:transparent;color:#6b7280;font-size:14px;cursor:pointer}
    .remove-btn:hover{color:#111}
    .summary-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-top:1px solid rgba(0,0,0,.08);border-bottom:1px solid rgba(0,0,0,.08);margin-bottom:14px;color:#111}
    .summary-row strong{font-size:30px;line-height:1.1}
    .checkout-form{display:grid;gap:14px}
    .field-grid{display:grid;gap:10px}
    .field-grid label{display:grid;gap:6px;font-size:14px;font-weight:600;color:#111}
    .field-grid input{height:44px;border:1px solid rgba(0,0,0,.15);border-radius:12px;padding:0 12px;font-size:15px}
    .delivery-group{border:1px solid rgba(0,0,0,.1);border-radius:12px;padding:12px;margin:0}
    .delivery-group legend{font-size:14px;font-weight:700;padding:0 8px}
    .delivery-group label{display:flex;gap:8px;align-items:center;font-size:14px;color:#111;margin-bottom:8px}
    .delivery-note{margin:8px 0 0;font-size:13px;color:#6b7280}
    .actions{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .dark-btn,.ghost-btn{height:46px;border-radius:12px;font-size:15px;font-weight:600;cursor:pointer}
    .dark-btn{background:#111;color:#fff;border:none}
    .dark-btn:hover{background:#000}
    .dark-btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost-btn{background:#fff;color:#111;border:1px solid rgba(0,0,0,.18)}
    .ghost-btn:hover{border-color:#111}
    .form-message{margin:12px 0 0;font-size:14px;line-height:1.5;min-height:22px}
    .form-message.ok{color:#166534}
    .form-message.err{color:#991b1b}
    .form-message.warn{color:#92400e}
    .empty-state{display:grid;gap:10px}
    .empty-state p{margin:0;color:#4b5563}
    @media (max-width: 1024px){
      .cart-grid{grid-template-columns:1fr}
    }
    @media (max-width: 768px){
      .cart-page{padding-top:84px}
      .cart-wrap{padding:0 16px}
      .cart-item{grid-template-columns:72px 1fr;align-items:flex-start}
      .cart-item img{width:72px;height:72px}
      .remove-btn{grid-column:2;justify-self:start;padding:0}
      .actions{grid-template-columns:1fr}
    }
  </style>
</Layout>
