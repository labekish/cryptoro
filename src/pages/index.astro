---
import Layout from '../layouts/Layout.astro';
import { loadLegacyPage } from '../lib/legacy';

const page = loadLegacyPage('index.html');
const formspreeId = import.meta.env.PUBLIC_FORMSPREE_ID ?? '';
type ProductFM = { slug: string; price: number };
const modules = import.meta.glob('../content/products/*.{md,mdx}', { eager: true }) as Record<
  string,
  { frontmatter: ProductFM }
>;
const prices = Object.values(modules).reduce<Record<string, number>>((acc, mod) => {
  if (mod.frontmatter?.slug) acc[mod.frontmatter.slug] = Number(mod.frontmatter.price || 0);
  return acc;
}, {});
const formatPrice = (value: number) => `${Math.round(Number(value || 0)).toLocaleString('ru-RU')} ₽`;

let syncedBody = page.body;

const replaceInProductCard = (slug: string, className: string, html: string, value: string) =>
  html.replace(
    new RegExp(`(<a[^>]*href="/products/${slug}"[\\s\\S]*?<div class="${className}">)([^<]*)(</div>)`, 'i'),
    `$1${value}$3`
  );

Object.entries(prices).forEach(([slug, price]) => {
  syncedBody = replaceInProductCard(slug, 'pprice', syncedBody, formatPrice(price));
});

if (prices.vspomnit != null) {
  syncedBody = syncedBody.replace(
    /(<div class="pricingcard feat[\s\S]*?<div class="pprice2">)([^<]*)(<\/div>)/i,
    `$1${formatPrice(prices.vspomnit)}$3`
  );
}

if (prices['plaud-note'] != null) {
  syncedBody = syncedBody.replace(
    /(<div class="pricingcard reg[\s\S]*?<div class="pprice2">)([\s\S]*?)(<\/div>)/i,
    `$1<span style="font-size:18px;font-weight:500;color:#6e6e73">от </span>${formatPrice(prices['plaud-note'])}$3`
  );
}
---
<Layout
  title={page.title}
  description="CRYPTORO — AI-диктофоны с ChatGPT. Записывайте встречи и лекции, получайте автоматическую расшифровку. Официальный дистрибьютор Plaud в России."
  globalCss={page.css}
  headScripts={page.headScripts}
  withChrome={false}
>
  <script slot="head" define:vars={{ formspreeId }} is:inline>
    window.CRYPTORO_FORMSPREE_ID = formspreeId;
  </script>
  <Fragment set:html={syncedBody} />
</Layout>
