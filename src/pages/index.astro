---
import Layout from '../layouts/Layout.astro';
import { loadLegacyPage } from '../lib/legacy';

const page = loadLegacyPage('index.html');
const formspreeId = import.meta.env.PUBLIC_FORMSPREE_ID ?? '';
type ProductFM = { slug: string; price: number };
const modules = import.meta.glob('../content/products/*.{md,mdx}', { eager: true }) as Record<
  string,
  { frontmatter: ProductFM }
>;
const prices = Object.values(modules).reduce<Record<string, number>>((acc, mod) => {
  if (mod.frontmatter?.slug) acc[mod.frontmatter.slug] = Number(mod.frontmatter.price || 0);
  return acc;
}, {});
---
<Layout
  title={page.title}
  description="CRYPTORO — AI-диктофоны с ChatGPT. Записывайте встречи и лекции, получайте автоматическую расшифровку. Официальный дистрибьютор Plaud в России."
  globalCss={page.css}
  headScripts={page.headScripts}
  withChrome={false}
>
  <script slot="head" define:vars={{ formspreeId }} is:inline>
    window.CRYPTORO_FORMSPREE_ID = formspreeId;
  </script>
  <Fragment set:html={page.body} />
  <script define:vars={{ prices }} is:inline>
    (() => {
      const fmt = (value) => `${Number(value || 0).toLocaleString('ru-RU')} ₽`;
      const update = () => {
        const map = prices || {};
        Object.entries(map).forEach(([slug, price]) => {
          const card = document.querySelector(`.pcard[href="/products/${slug}"]`);
          if (card) {
            const priceNode = card.querySelector('.pprice');
            if (priceNode) priceNode.textContent = fmt(price);
          }
        });

        const mainPriceNode = document.querySelector('.pricingcard.feat .pprice2');
        if (mainPriceNode && map.vspomnit != null) mainPriceNode.textContent = fmt(map.vspomnit);

        const lineNode = document.querySelector('.pricingcard.reg .pprice2');
        if (lineNode && map['plaud-note'] != null) {
          lineNode.innerHTML = `<span style="font-size:18px;font-weight:500;color:#6e6e73">от </span>${fmt(map['plaud-note'])}`;
        }
      };
      // Run after legacy inline scripts.
      window.addEventListener('load', update);
      setTimeout(update, 120);
      setTimeout(update, 600);
    })();
  </script>
</Layout>
