---
import TinaAdminApp from '../../components/TinaAdminApp.jsx';
---

<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CRYPTORO Admin</title>
    <link rel="stylesheet" href="/admin/custom.css" />
    <style is:global>
      html,
      body {
        margin: 0;
        height: 100dvh;
        min-height: 100dvh;
        background: #f3f4f6;
        font-family: Inter, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        overflow: auto;
      }
      astro-island {
        display: block;
        height: 100dvh;
        min-height: 100dvh;
      }
      .tina-tailwind,
      [data-tina-root],
      [data-test='tina-admin'] {
        height: 100dvh !important;
        min-height: 100dvh !important;
        overflow: auto !important;
      }
      /* Tina иногда ставит overflow-hidden/h-screen на обертки, из-за чего форма обрезается */
      [data-tina-root] .overflow-hidden,
      [data-test='tina-admin'] .overflow-hidden {
        overflow: visible !important;
      }
      [data-tina-root] .h-screen,
      [data-test='tina-admin'] .h-screen,
      [data-tina-root] .h-full,
      [data-test='tina-admin'] .h-full {
        max-height: none !important;
      }
      /* Не даем внутренним строкам вылезать по ширине и прятать Save справа */
      [data-tina-root] .w-full,
      [data-test='tina-admin'] .w-full,
      [data-tina-root] .max-w-full,
      [data-test='tina-admin'] .max-w-full {
        width: 100% !important;
        max-width: 100% !important;
      }
      .tina-tailwind main,
      [data-test='tina-admin'] main {
        overflow-y: auto !important;
        overscroll-behavior: contain;
        max-height: calc(100dvh - 48px) !important;
        padding-bottom: 120px !important;
      }
      #codex-admin-save-fab {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 2147483000;
        border: none;
        border-radius: 999px;
        padding: 10px 16px;
        background: #111;
        color: #fff;
        font-size: 14px;
        font-weight: 600;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.24);
        cursor: pointer;
      }
      #codex-admin-save-fab[disabled] {
        opacity: 0.55;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <TinaAdminApp client:only="react" />
    <script is:inline>
      (() => {
        const forceScrollStyles = () => {
          document.documentElement.style.setProperty('height', '100%', 'important');
          document.documentElement.style.setProperty('overflow', 'auto', 'important');
          document.body.style.setProperty('height', '100%', 'important');
          document.body.style.setProperty('min-height', '100vh', 'important');
          document.body.style.setProperty('overflow', 'auto', 'important');
        };

        const findSaveButton = () => {
          const candidates = [...document.querySelectorAll('button, [role="button"], a[role="button"]')];
          return candidates.find((el) => {
            const text = (el.textContent || '').toLowerCase();
            const aria = (el.getAttribute('aria-label') || '').toLowerCase();
            const title = (el.getAttribute('title') || '').toLowerCase();
            const testid = (el.getAttribute('data-testid') || '').toLowerCase();
            const dataTest = (el.getAttribute('data-test') || '').toLowerCase();
            return (
              /save|сохран/.test(text) ||
              /save|сохран/.test(aria) ||
              /save|сохран/.test(title) ||
              testid.includes('save') ||
              dataTest.includes('save')
            );
          });
        };

        const patchTinaLayout = () => {
          forceScrollStyles();

          const root =
            document.querySelector('[data-test="tina-admin"]') ||
            document.querySelector('[data-tina-root]') ||
            document.querySelector('.tina-tailwind');

          if (!root) return;

          root.style.setProperty('height', 'auto', 'important');
          root.style.setProperty('min-height', '100vh', 'important');
          root.style.setProperty('overflow', 'visible', 'important');

          const allNodes = root.querySelectorAll('*');
          allNodes.forEach((el) => {
            const computed = window.getComputedStyle(el);
            if (computed.overflowY === 'hidden') {
              el.style.setProperty('overflow-y', 'visible', 'important');
            }
            if (computed.overflow === 'hidden') {
              el.style.setProperty('overflow', 'visible', 'important');
            }
          });

          // Находим самый вероятный скролл-контейнер внутри Tina и включаем вертикальный скролл.
          const candidates = [root, ...root.querySelectorAll('main, [role="main"], div')];
          let best = null;
          let bestDelta = 0;
          for (const el of candidates) {
            const delta = el.scrollHeight - el.clientHeight;
            if (delta > bestDelta) {
              bestDelta = delta;
              best = el;
            }
          }
          if (best) {
            best.style.setProperty('overflow-y', 'auto', 'important');
            best.style.setProperty('max-height', 'calc(100dvh - 48px)', 'important');
            best.style.setProperty('padding-bottom', '120px', 'important');
            best.style.setProperty('scroll-padding-bottom', '120px', 'important');
          }

          // Фиксируем панель с кнопкой Save, чтобы она не уезжала вниз.
          const saveCandidate = findSaveButton();
          const saveButtons = saveCandidate ? [saveCandidate] : [];
          saveButtons.forEach((btn) => {
            const bar = btn.closest('div');
            if (!bar) return;
            bar.style.setProperty('position', 'sticky', 'important');
            bar.style.setProperty('bottom', '0', 'important');
            bar.style.setProperty('z-index', '999', 'important');
            bar.style.setProperty('background', '#f3f4f6', 'important');
            bar.style.setProperty('padding', '10px 12px', 'important');
            bar.style.setProperty('border-top', '1px solid rgba(17,24,39,.12)', 'important');
          });

          // Страховка: плавающая кнопка "Сохранить", всегда доступна
          let fab = document.getElementById('codex-admin-save-fab');
          if (!fab) {
            fab = document.createElement('button');
            fab.id = 'codex-admin-save-fab';
            fab.type = 'button';
            fab.textContent = 'Сохранить';
            Object.assign(fab.style, {
              position: 'fixed',
              right: '16px',
              bottom: '16px',
              zIndex: '2147483000',
              border: 'none',
              borderRadius: '999px',
              padding: '10px 16px',
              background: '#111',
              color: '#fff',
              fontSize: '14px',
              fontWeight: '600',
              boxShadow: '0 8px 24px rgba(0,0,0,.24)',
              cursor: 'pointer'
            });
            fab.addEventListener('click', () => {
              const target = findSaveButton();
              if (target && !target.disabled) {
                target.click();
                return;
              }
              if (best) {
                best.scrollTo({ top: best.scrollHeight, behavior: 'smooth' });
              } else {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
              }
            });
            document.body.appendChild(fab);
          }
          const activeSave = findSaveButton();
          if (activeSave) {
            fab.disabled = activeSave.disabled;
            fab.style.display = 'inline-flex';
          } else {
            fab.disabled = false;
            fab.style.display = 'inline-flex';
          }
        };

        window.addEventListener('load', patchTinaLayout);
        window.addEventListener('hashchange', () => setTimeout(patchTinaLayout, 150));
        setTimeout(patchTinaLayout, 500);
        setTimeout(patchTinaLayout, 1500);
        window.setInterval(patchTinaLayout, 1200);
      })();
    </script>
  </body>
</html>
